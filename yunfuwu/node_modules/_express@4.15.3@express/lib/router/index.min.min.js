/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var Route=require("./route");var Layer=require("./layer");var methods=require("methods");var mixin=require("utils-merge");var debug=require("debug")("express:router");var deprecate=require("depd")("express");var flatten=require("array-flatten");var parseUrl=require("parseurl");var setPrototypeOf=require("setprototypeof");var objectRegExp=/^\[object (\S+)\]$/;var slice=Array.prototype.slice;var toString=Object.prototype.toString;var proto=module.exports=function(d){var f=d||{};function e(a,c,b){e.handle(a,c,b)}setPrototypeOf(e,proto);e.params={};e._params=[];e.caseSensitive=f.caseSensitive;e.mergeParams=f.mergeParams;e.strict=f.strict;e.stack=[];return e};proto.param=function param(l,j){if(typeof l==="function"){deprecate("router.param(fn): Refactor to use path params");this._params.push(l);return}var i=this._params;var h=i.length;var g;if(l[0]===":"){deprecate("router.param("+JSON.stringify(l)+", fn): Use router.param("+JSON.stringify(l.substr(1))+", fn) instead");l=l.substr(1)}for(var k=0;k<h;++k){if(g=i[k](l,j)){j=g}}if("function"!==typeof j){throw new Error("invalid param() call for "+l+", got "+j)}(this.params[l]=this.params[l]||[]).push(j);return this};proto.handle=function handle(u,w,B){var s=this;debug("dispatching %s %s",u.method,u.url);var t=0;var E=getProtohost(u.url)||"";var x="";var z=false;var D={};var q=[];var v=s.stack;var r=u.params;var F=u.baseUrl||"";var C=restore(B,u,"baseUrl","next","params");u.next=y;if(u.method==="OPTIONS"){C=wrap(C,function(b,a){if(a||q.length===0){return b(a)}sendOptionsResponse(w,q,b)})}u.baseUrl=F;u.originalUrl=u.originalUrl||u.url;y();function y(a){var e=a==="route"?null:a;if(z){u.url=u.url.substr(1);z=false}if(x.length!==0){u.baseUrl=F;u.url=E+x+u.url.substr(E.length);x=""}if(e==="router"){setImmediate(C,null);return}if(t>=v.length){setImmediate(C,e);return}var c=getPathname(u);if(c==null){return C(e)}var g;var h;var d;while(h!==true&&t<v.length){g=v[t++];h=matchLayer(g,c);d=g.route;if(typeof h!=="boolean"){e=e||h}if(h!==true){continue}if(!d){continue}if(e){h=false;continue}var b=u.method;var f=d._handles_method(b);if(!f&&b==="OPTIONS"){appendMethods(q,d._options())}if(!f&&b!=="HEAD"){h=false;continue}}if(h!==true){return C(e)}if(d){u.route=d}u.params=s.mergeParams?mergeParams(g.params,r):g.params;var i=g.path;s.process_params(g,D,u,w,function(j){if(j){return y(e||j)}if(d){return g.handle_request(u,w,y)}A(g,e,i,c)})}function A(d,e,b,c){if(b.length!==0){var a=c[b.length];if(a&&a!=="/"&&a!=="."){return y(e)}debug("trim prefix (%s) from url %s",b,u.url);x=b;u.url=E+u.url.substr(E.length+x.length);if(!E&&u.url[0]!=="/"){u.url="/"+u.url;z=true}u.baseUrl=F+(x[x.length-1]==="/"?x.substring(0,x.length-1):x)}debug("%s %s : %s",d.name,b,u.originalUrl);if(e){d.handle_error(e,u,w,y)}else{d.handle_request(u,w,y)}}};proto.process_params=function process_params(z,u,w,x,B){var D=this.params;var r=z.keys;if(!r||r.length===0){return B()}var A=0;var F;var i=0;var s;var t;var v;var y;function E(a){if(a){return B(a)}if(A>=r.length){return B()}i=0;s=r[A++];F=s.name;t=w.params[F];v=D[F];y=u[F];if(t===undefined||!v){return E()}if(y&&(y.match===t||(y.error&&y.error!=="route"))){w.params[F]=y.value;return E(y.error)}u[F]=y={error:null,match:t,value:t};C()}function C(c){var a=v[i++];y.value=w.params[s.name];if(c){y.error=c;E(c);return}if(!a){return E()}try{a(w,x,C,t,s.name)}catch(b){C(b)}}E()};proto.use=function use(m){var j=0;var k="/";if(typeof m!=="function"){var i=m;while(Array.isArray(i)&&i.length!==0){i=i[0]}if(typeof i!=="function"){j=1;k=m}}var l=flatten(slice.call(arguments,j));if(l.length===0){throw new TypeError("Router.use() requires middleware functions")}for(var n=0;n<l.length;n++){var m=l[n];if(typeof m!=="function"){throw new TypeError("Router.use() requires middleware function but got a "+gettype(m))}debug("use %o %s",k,m.name||"<anonymous>");var h=new Layer(k,{sensitive:this.caseSensitive,strict:false,end:false},m);h.route=undefined;this.stack.push(h)}return this};proto.route=function route(f){var e=new Route(f);var d=new Layer(f,{sensitive:this.caseSensitive,strict:this.strict,end:true},e.dispatch.bind(e));d.route=e;this.stack.push(d);return e};methods.concat("all").forEach(function(b){proto[b]=function(d){var a=this.route(d);a[b].apply(a,slice.call(arguments,1));return this}});function appendMethods(h,f){for(var e=0;e<f.length;e++){var g=f[e];if(h.indexOf(g)===-1){h.push(g)}}}function getPathname(c){try{return parseUrl(c).pathname}catch(d){return undefined}}function getProtohost(e){if(typeof e!=="string"||e.length===0||e[0]==="/"){return undefined}var f=e.indexOf("?");var g=f!==-1?f:e.length;var h=e.substr(0,g).indexOf("://");return h!==-1?e.substr(0,e.indexOf("/",3+h)):undefined}function gettype(c){var d=typeof c;if(d!=="object"){return d}return toString.call(c).replace(objectRegExp,"$1")}function matchLayer(e,f){try{return e.match(f)}catch(d){return d}}function mergeParams(h,f){if(typeof f!=="object"||!f){return h}var j=mixin({},f);if(!(0 in h)||!(0 in f)){return mixin(j,h)}var g=0;var i=0;while(g in h){g++}while(i in f){i++}for(g--;g>=0;g--){h[g+i]=h[g];if(g<i){delete h[g]}}return mixin(j,h)}function restore(j,h){var f=new Array(arguments.length-2);var i=new Array(arguments.length-2);for(var g=0;g<f.length;g++){f[g]=arguments[g+2];i[g]=h[f[g]]}return function(){for(var a=0;a<f.length;a++){h[f[a]]=i[a]}return j.apply(this,arguments)}}function sendOptionsResponse(j,f,i){try{var g=f.join(",");j.set("Allow",g);j.send(g)}catch(h){i(h)}}function wrap(e,f){return function d(){var b=new Array(arguments.length+1);b[0]=e;for(var a=0,c=arguments.length;a<c;a++){b[a+1]=arguments[a]}f.apply(this,b)}};